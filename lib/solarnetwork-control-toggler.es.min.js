function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}import{request}from"d3-request";import{queue}from"d3-queue";import{InstructionStates,AuthorizationV2Builder,NodeDatumUrlHelper,Logger,InstructionState,dateParser,HttpHeaders,HttpMethod,HttpContentType}from"solarnetwork-api-core";var SetControlParameterInstructionName="SetControlParameter",InstructionActiveStates=new Set([InstructionStates.Queued,InstructionStates.Received,InstructionStates.Executing]),InstructionFinishedStates=new Set([InstructionStates.Completed,InstructionStates.Declined]),ControlToggler=function(){function t(e,n,r,i){_classCallCheck(this,t),this.instructionUrlHelper=e,this.authBuilder=n||new AuthorizationV2Builder(null,e?e.environment:void 0),this.controlId=r,this.queryUrlHelper=i||new NodeDatumUrlHelper(e.environment),this.queryUrlHelper.nodeId=e.nodeId,this.queryUrlHelper.sourceId=r,this.timer=null,this.lastKnownDatum=void 0,this.lastKnownInstruction=void 0,this.refreshMs=2e4,this.pendingRefreshMs=5e3,this.callback=void 0}return _createClass(t,[{key:"notifyDelegate",value:function(t){var e=this.callback;if(void 0!==e)try{e.call(self,t)}catch(t){Logger.error("Error in callback: %s",t)}}},{key:"getActiveInstruction",value:function(t){if(Array.isArray(t)&&0!==t.length){var e=this.controlId,n=t.reduce(function(t,n){return n.topic===SetControlParameterInstructionName&&Array.isArray(n.parameters)&&n.parameters.length>0&&n.parameters[0].name===e&&(void 0===t||t.created<n.created)?n:t},void 0);return void 0!==n&&Logger.debug("Active instruction for %d found in state %s (set control %s to %s)",this.instructionUrlHelper.nodeId,n.state,e,n.parameters[0].value),n}}},{key:"lastKnownInstructionState",value:function(){var t=this.lastKnownInstruction;return void 0===t?void 0:InstructionState.valueOf(t.state)}},{key:"lastKnownInstructionValue",value:function(){var t=this.lastKnownInstruction;return void 0===t?void 0:Number(t.parameters[0].value)}},{key:"currentRefreshMs",value:function(){return this.hasPendingStateChange?this.pendingRefreshMs:this.refreshMs}},{key:"mostRecentValue",value:function(t,e){if(!e||InstructionStates.Declined.equals(e.status))return t?t.val:void 0;if(!t)return Number(e.parameters[0].value);var n=dateParser(t.created),r=dateParser(e.created);return n.getTime()>r.getTime()?t.val:Number(e.parameters[0].value)}},{key:"handleRequestAuth",value:function(t,e,n,r){var i=new Date;this.authBuilder.reset().date(i).snDate(!0).method(e).url(n),r&&this.authBuilder.contentType(r),t.setRequestHeader(HttpHeaders.X_SN_DATE,this.authBuilder.requestDateHeaderValue),t.setRequestHeader(HttpHeaders.AUTHORIZATION,this.authBuilder.buildWithSavedKey())}},{key:"deferJsonRequestWithAuth",value:function(t,e,n){var r=this,i=-1,s=void 0,o=void 0;e!==HttpMethod.GET&&(i=n.indexOf("?"),s=n.substring(i+1),o=HttpContentType.FORM_URLENCODED_UTF8);var a=request(i>=0?n.substring(0,i):n).mimeType(HttpContentType.APPLICATION_JSON).on("beforesend",function(t){r.handleRequestAuth(t,e,n,o)});return o&&a.header("Content-Type",o),t.defer(a.send,e,s),this}},{key:"value",value:function(t){var e=this;if(!arguments.length)return void 0===this.lastKnownDatum?void 0:this.lastKnownDatum.val;if(!this.authBuilder.signingKeyValid)throw new Error("Valid credentials not configured");var n=this.controlId,r=this.instructionUrlHelper,i=queue(),s=void 0===this.lastKnownDatum?void 0:this.lastKnownDatum.val,o=this.lastKnownInstructionState(),a=this.lastKnownInstructionValue();if(o===InstructionStates.Queued&&a!==t){Logger.debug("Canceling %d pending control %s switch to %s",r.nodeId,n,a);var u=r.updateInstructionStateUrl(this.lastKnownInstruction.id,InstructionStates.Declined);this.deferJsonRequestWithAuth(i,HttpMethod.POST,u),this.lastKnownInstruction=void 0,o=void 0,a=void 0}if(s!==t&&a!==t){Logger.debug("Request %d to change control %s to %d",r.nodeId,n,t);var l=r.queueInstructionUrl(SetControlParameterInstructionName,[{name:n,value:String(t)}]);this.deferJsonRequestWithAuth(i,HttpMethod.POST,l)}return i.awaitAll(function(t,i){if(t)return Logger.error("Error updating %d control toggler %s: %s",r.nodeId,n,t.status),void e.notifyDelegate(t);if(!(i.length<1)){i.forEach(function(t,e){t.responseText&&(i[e]=JSON.parse(t.responseText))});var s=i[0];null==s.data&&!0===s.success&&(e.lastKnownInstruction=void 0);var o=i[i.length-1].data;null!=o&&(e.lastKnownInstruction=o),e.notifyDelegate(),e.timer&&(e.stop(),e.start(e.currentRefreshMs()))}}),this}},{key:"update",value:function(){var t=this;if(!this.authBuilder.signingKeyValid)throw new Error("Valid credentials not configured");var e=this.controlId,n=this.instructionUrlHelper,r=this.queryUrlHelper,i=queue(),s=r.mostRecentDatumUrl();this.deferJsonRequestWithAuth(i,HttpMethod.GET,s);var o=n.viewPendingInstructionsUrl();if(this.deferJsonRequestWithAuth(i,HttpMethod.GET,o),this.lastKnownInstruction&&!InstructionFinishedStates.has(this.lastKnownInstructionState())){var a=n.viewInstructionUrl(this.lastKnownInstruction.id);this.deferJsonRequestWithAuth(i,HttpMethod.GET,a)}return i.awaitAll(function(r,i){if(r)Logger.error("Error querying %d control toggler %s status: %s",n.nodeId,e,r.status),t.notifyDelegate(r);else{i.forEach(function(t,e){t.responseText&&(i[e]=JSON.parse(t.responseText))});var s,o,a;i.length>0&&(s=i[0]),i.length>1&&(o=i[1]),i.length>2&&(a=i[2]);var u=void 0;s.data&&Array.isArray(s.data.results)&&(u=s.data.results.find(function(t){return t.sourceId===e}));var l=a?a.data:void 0,d=o?t.getActiveInstruction(o.data):void 0,c=t.mostRecentValue(u,l||(d||t.lastKnownInstruction));(c!==t.value()||l)&&(Logger.debug("Current %d control %s value is %s",n.nodeId,e,void 0!==c?c:"N/A"),t.lastKnownDatum=u,t.lastKnownDatum&&!d&&(t.lastKnownDatum.val=c),t.lastKnownInstruction=l||d,t.notifyDelegate())}void 0!==t.timer&&(t.timer=setTimeout(function(){t.update()},t.currentRefreshMs()))}),this}},{key:"start",value:function(t){var e=this;return this.timer||(this.timer=setTimeout(function(){e.update()},t||20)),this}},{key:"stop",value:function(){var t=this.timer;return t&&(clearTimeout(t),this.timer=null),this}},{key:"hasPendingStateChange",get:function(){return InstructionActiveStates.has(this.lastKnownInstructionState())}}]),t}();export{ControlToggler};