!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-request"),require("d3-queue"),require("solarnetwork-api-core")):"function"==typeof define&&define.amd?define(["exports","d3-request","d3-queue","solarnetwork-api-core"],e):e(t.sn=t.sn||{},t.d3,t.d3,t.sn)}(this,function(t,e,n,r){"use strict";var i=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},s=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),o=new Set([r.InstructionStates.Queued,r.InstructionStates.Received,r.InstructionStates.Executing]),a=new Set([r.InstructionStates.Completed,r.InstructionStates.Declined]),u=function(){function t(e,n,s,o){i(this,t),this.instructionUrlHelper=e,this.authBuilder=n||new r.AuthorizationV2Builder(null,e?e.environment:void 0),this.controlId=s,this.queryUrlHelper=o||new r.NodeDatumUrlHelper(e.environment),this.queryUrlHelper.nodeId=e.nodeId,this.queryUrlHelper.sourceId=s,this.timer=null,this.lastKnownDatum=void 0,this.lastKnownInstruction=void 0,this.refreshMs=2e4,this.pendingRefreshMs=5e3,this.callback=void 0}return s(t,[{key:"notifyDelegate",value:function(t){var e=this.callback;if(void 0!==e)try{e.call(self,t)}catch(t){r.Logger.error("Error in callback: %s",t)}}},{key:"getActiveInstruction",value:function(t){if(Array.isArray(t)&&0!==t.length){var e=this.controlId,n=t.reduce(function(t,n){return"SetControlParameter"===n.topic&&Array.isArray(n.parameters)&&n.parameters.length>0&&n.parameters[0].name===e&&(void 0===t||t.created<n.created)?n:t},void 0);return void 0!==n&&r.Logger.debug("Active instruction for %d found in state %s (set control %s to %s)",this.instructionUrlHelper.nodeId,n.state,e,n.parameters[0].value),n}}},{key:"lastKnownInstructionState",value:function(){var t=this.lastKnownInstruction;return void 0===t?void 0:r.InstructionState.valueOf(t.state)}},{key:"lastKnownInstructionValue",value:function(){var t=this.lastKnownInstruction;return void 0===t?void 0:Number(t.parameters[0].value)}},{key:"currentRefreshMs",value:function(){return self.hasPendingStateChange?this.pendingRefreshMs:this.refreshMs}},{key:"mostRecentValue",value:function(t,e){if(!e||r.InstructionStates.Declined.equals(e.status))return t?t.val:void 0;if(!t)return Number(e.parameters[0].value);var n=r.dateParser(t.created),i=r.dateParser(e.created);return n.getTime()>i.getTime()?t.val:Number(e.parameters[0].value)}},{key:"handleRequestAuth",value:function(t,e,n,i){var s=new Date;this.authBuilder.reset().date(s).snDate(!0).method(e).url(n),i&&this.authBuilder.contentType(i),t.setRequestHeader(r.HttpHeaders.X_SN_DATE,this.authBuilder.requestDateHeaderValue),t.setRequestHeader(r.HttpHeaders.AUTHORIZATION,this.authBuilder.buildWithSavedKey())}},{key:"deferJsonRequestWithAuth",value:function(t,n,i){var s=this,o=-1,a=void 0,u=void 0;n!==r.HttpMethod.GET&&(o=i.indexOf("?"),a=i.substring(o+1),u=r.HttpContentType.FORM_URLENCODED_UTF8);var l=e.request(o>=0?i.substring(0,o):i).mimeType(r.HttpContentType.APPLICATION_JSON).on("beforesend",function(t){s.handleRequestAuth(t,n,i,u)});return t.defer(l.send,n,a),this}},{key:"value",value:function(t){var e=this;if(!arguments.length)return void 0===this.lastKnownDatum?void 0:this.lastKnownDatum.val;if(!this.authBuilder.signingKeyValid)throw new Error("Valid credentials not configured");var i=this.controlId,s=this.instructionUrlHelper,o=n.queue(),a=void 0===this.lastKnownDatum?void 0:this.lastKnownDatum.val,u=this.lastKnownInstructionState(),l=this.lastKnownInstructionValue();if(u===r.InstructionStates.Queued&&l!==t){r.Logger.debug("Canceling %d pending control %s switch to %s",s.nodeId,i,l);var d=s.updateInstructionStateUrl(this.lastKnownInstruction.id,r.InstructionStates.Declined);this.deferJsonRequestWithAuth(o,r.HttpMethod.POST,d),this.lastKnownInstruction=void 0,u=void 0,l=void 0}if(a!==t&&l!==t){r.Logger.debug("Request %d to change control %s to %d",s.nodeId,i,t);var c=s.queueInstructionUrl("SetControlParameter",[{name:i,value:String(t)}]);this.deferJsonRequestWithAuth(o,r.HttpMethod.POST,c)}return o.awaitAll(function(t,n){if(t)return r.Logger.error("Error updating %d control toggler %s: %s",s.nodeId,i,t.status),void e.notifyDelegate(t);if(!(n.length<1)){n.forEach(function(t,e){t.responseText&&(n[e]=JSON.parse(t.responseText))});var o=n[0];null==o.data&&!0===o.success&&(e.lastKnownInstruction=void 0);var a=n[n.length-1].data;null!=a&&(e.lastKnownInstruction=a),e.notifyDelegate(),e.timer&&(e.stop(),e.start(e.currentRefreshMs()))}}),this}},{key:"update",value:function(){var t=this;if(!this.authBuilder.signingKeyValid)throw new Error("Valid credentials not configured");var e=this.controlId,i=this.instructionUrlHelper,s=this.queryUrlHelper,o=n.queue(),u=s.mostRecentDatumUrl();this.deferJsonRequestWithAuth(o,r.HttpMethod.GET,u);var l=i.viewPendingInstructionsUrl();if(this.deferJsonRequestWithAuth(o,r.HttpMethod.GET,l),this.lastKnownInstruction&&!a.has(this.lastKnownInstructionState())){var d=i.viewInstructionUrl(this.lastKnownInstruction.id);this.deferJsonRequestWithAuth(o,r.HttpMethod.GET,d)}return o.awaitAll(function(n,s){if(n)r.Logger.error("Error querying %d control toggler %s status: %s",i.nodeId,e,n.status),t.notifyDelegate(n);else{s.forEach(function(t,e){t.responseText&&(s[e]=JSON.parse(t.responseText))});var o=void 0,a=void 0,u=void 0;s.length>0&&(o=s[0]),s.length>1&&(a=s[1]),s.length>2&&(u=s[2]);var l=void 0;o.data&&Array.isArray(o.data.results)&&(l=o.data.results.find(function(t){return t.sourceId===e}));var d=u?u.data:void 0,c=a?t.getActiveInstruction(a.data):void 0,h=t.mostRecentValue(l,d||(c||t.lastKnownInstruction));h!==t.value()&&(r.Logger.debug("Current %d control %s value is %s",i.nodeId,e,void 0!==h?h:"N/A"),t.lastKnownDatum=l,t.lastKnownDatum&&!c&&(t.lastKnownDatum.val=h),t.lastKnownInstruction=d||c,t.notifyDelegate())}void 0!==t.timer&&(t.timer=setTimeout(function(){t.update()},t.currentRefreshMs()))}),this}},{key:"start",value:function(t){var e=this;return this.timer||(this.timer=setTimeout(function(){e.update()},t||20)),this}},{key:"stop",value:function(){var t=this.timer;return t&&(clearTimeout(t),this.timer=null),this}},{key:"hasPendingStateChange",get:function(){return o.has(this.lastKnownInstructionState())}}]),t}();t.ControlToggler=u,Object.defineProperty(t,"__esModule",{value:!0})});